<workflow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xmlns="http://levelsbeyond.com/schema/workflow"
          xmlns:nimbus="http://levelsbeyond.com/schema/workflow/nimbus"
          xsi:schemaLocation="http://levelsbeyond.com/schema/workflow http://www.levelsbeyond.com/schema/latest/studio.xsd"
          id="setLocationFromGPS"
          name="Set Location from GPS"
          executionLabelExpression="Set Location from GPS - ${subject.name}"
          description=""
          adminOnly="true"
          showInUserInterface="true"
          subjectDOClassName="AssetMaster"
          subjectQualifierExpression="${metadata.gPSCoordinates != null}"
          sdkVersion="">

    <initialStepName>set gps coords</initialStepName>

    <groovyStep
            name="set gps coords"
            resultDataDef="gpsCoordsString"
            nextStep="get location from google">
        <transition condition="${gpsCoordsString != null}">
            <targetStepName>get location from google</targetStepName>
        </transition>
        <transition condition="true">
            <targetStepName>end</targetStepName>
        </transition>
        <script>
            <![CDATA[
            // Example: 39 deg 52' 47.64" N, 105 deg 7' 21.00" W, 1697.325 m Above Sea Level

            parts = gpsData.split(',')

            if (parts.size() != 3) return null

            // Calculate latitute
            latParts = parts[0].trim().split(' ')
            latDegrees = Double.parseDouble(latParts[0])
            latMinutes = Double.parseDouble(latParts[2].replaceAll("'", ""))
            latSeconds = Double.parseDouble(latParts[3].replaceAll('"', ''))

            latDecimalDegrees = latDegrees + (latMinutes/60) + (latSeconds/3600)
            if (latParts[4] == 'S') latDecimalDegrees = latDecimalDegrees * (-1)

            // Calculate longitude
            longParts = parts[1].trim().split(' ')
            longDegrees = Double.parseDouble(longParts[0])
            longMinutes = Double.parseDouble(longParts[2].replaceAll("'", ""))
            longSeconds = Double.parseDouble(longParts[3].replaceAll('"', ''))

            longDecimalDegrees = longDegrees + (longMinutes/60) + (longSeconds/3600)
            if (longParts[4] == 'W') longDecimalDegrees = longDecimalDegrees * (-1)

            return latDecimalDegrees.toString() + ',' + longDecimalDegrees.toString()
            ]]>
        </script>
    </groovyStep>

    <submitHttpStep
            name="get location from google"
            requestMethodExpression="GET"
            urlExpression="https://maps.googleapis.com/maps/api/geocode/json?latlng=${gpsCoordsString}&amp;key=${#sysconfig('google.api.key')}"
            responseCodeDataDef="googleResponseCode"
            responsePayloadDataDef="googleResponseString">
        <transition condition="${googleResponseCode == 200}">
            <targetStepName>set google response json</targetStepName>
        </transition>
        <transition condition="true">
            <targetStepName>google response failure</targetStepName>
        </transition>
    </submitHttpStep>

    <setContextData
            name="set google response json"
            targetDataDef="googleResponseJson"
            valueExpression="${googleResponseString}"
            nextStep="parse google response for location"/>

    <groovyStep
            name="parse google response for location"
            executionLabelExpression="Set location: '${locationJson.toString()}'"
            resultDataDef="locationJson"
            nextStep="save location metadata">
        <transition condition="${locationJson.location != null}">
            <targetStepName>save location metadata</targetStepName>
        </transition>
        <transition condition="${locationJson.address != null}">
            <targetStepName>save google maps link metadata result</targetStepName>
        </transition>
        <transition condition="true">
            <targetStepName>end</targetStepName>
        </transition>
        <script>
            <![CDATA[
            import groovy.json.JsonSlurper

            formattedAddress = googleResponseJson.results.get(0).formatted_address.asText()
            googleMapsID = googleResponseJson.results.get(0).place_id.asText()

            locationJson.put('address', formattedAddress)
            locationJson.put('googleMapsUrl', 'https://www.google.com/maps/search/?api=1&query=' + java.net.URLEncoder.encode(formattedAddress, "UTF-8") + '&query_place_id=' + googleMapsID)
            locationJson.put('appleMapsUrl', 'http://maps.apple.com/?address' + java.net.URLEncoder.encode(formattedAddress, "UTF-8"))

            if (formattedAddress.contains('Owens')) {
                locationJson.put('location', 'Home')
                return locationJson
            }
            if (formattedAddress.contains('Durango')) {
                locationJson.put('location', 'Durango')
                return locationJson
            }
            if (formattedAddress.contains('Kona')) {
                locationJson.put('location', 'Kona')
                return locationJson
            }
            if (formattedAddress.contains('Redlands')) {
                locationJson.put('location', 'Redlands')
                return locationJson
            }
            if (formattedAddress.contains('Yucca Valley')) {
                locationJson.put('location', 'Yucca Valley')
                return locationJson
            }
            if (formattedAddress.contains('6400') && formattedAddress.contains('Westminster')) {
                locationJson.put('location', 'Costco')
                return locationJson
            }
            if (formattedAddress.equals('10385 Westmoor Dr, Westminster, CO 80021, USA')) {
                locationJson.put('location', 'Driving Range')
                return locationJson
            }
            if (formattedAddress.equals('10431 Town Center Dr, Broomfield, CO 80021, USA')) {
                locationJson.put('location', 'East Moon')
                return locationJson
            }
            if (formattedAddress.equals('14694 Orchard Pkwy, Westminster, CO 80023, USA') || formattedAddress.equals('16494 Orchard Pkwy, Westminster, CO 80023, USA')) {
                locationJson.put('location', 'Pigtails and Crewcuts')
                return locationJson
            }

            locationPicklistItems = new JsonSlurper().parseText(queryReach('GET', '/reachengine/api/metadata-properties/' + locationMetaId + '/picklist-items?limit=500', null))

            exists = false
            locationPicklistItems.each { item ->
                if (item.displayName == formattedAddress) {
                    exists = true
                }
            }
            if (!exists) {
                queryReach('PUT', '/reachengine/api/metadata-properties/' + locationMetaId + '/add-picklist-items', '[{"displayName":"' + formattedAddress +'"}]')
            }

            locationJson.put('location', formattedAddress)
            return locationJson

            String queryReach (String method, String uri, String body) {
                connection = new URL(reachUrl + uri).openConnection()
                connection.setRequestProperty("Content-Type", "application/json")
                connection.setRequestProperty("apiKey", workflowApiKey)
                connection.setRequestProperty("api-version", "2.0")

                if ((method == 'POST' || method == 'PUT') && body != null) {
                    connection.setRequestMethod(method)
                    connection.setDoOutput(true)
                    connection.getOutputStream().write(body.getBytes("UTF-8"))
                }

                responseCode = connection.responseCode
                if (responseCode.equals(200)) {
                    return connection.inputStream.text
                } else {
                    println('---- Query Reach FAILURE ----')
                    println('Response Code = ' + responseCode)
                    println('Message = ' + connection.responseMessage)
                    println('Method = ' + method)
                    println('URI = ' + uri)
                    if (body != null) println('Body = ' + body)
                    return null
                }
            }
            ]]>
        </script>
    </groovyStep>

    <saveDataObjectStep
            name="save location metadata"
            dataObjectExpression="${asset.metadata}">
        <transition condition="${locationJson.address != null}">
            <targetStepName>save google maps link metadata result</targetStepName>
        </transition>
        <transition condition="true">
            <targetStepName>reindex</targetStepName>
        </transition>
        <property name="location">${locationJson.location}</property>
    </saveDataObjectStep>


    <setAssociationMetadataStep
            name="save google maps link metadata result"
            targetExpression="${asset}"
            propertyNameExpression="googleMaps"
            valueExpression="{&quot;title&quot;: &quot;${locationJson.address}&quot;, &quot;url&quot;: &quot;${locationJson.googleMapsUrl}&quot;}"
            nextStep="save apple maps link metadata result"/>

    <setAssociationMetadataStep
            name="save apple maps link metadata result"
            targetExpression="${asset}"
            propertyNameExpression="appleMaps"
            valueExpression="{&quot;title&quot;: &quot;${locationJson.address}&quot;, &quot;url&quot;: &quot;${locationJson.appleMapsUrl}&quot;}"
            nextStep="reindex"/>


    <raiseWorkflowEventStep
            name="reindex"
            eventTypeExpression="ensureIndexed"
            executionLabelExpression="Ensure Asset Indexed"
            nextStep="end">
        <property name="indexTargetRef">${asset}</property>
    </raiseWorkflowEventStep>

    <failWorkflowStep name="google response failure" reasonExpression="Query Google failed. Code: ${googleResponseCode}. URL: : https://maps.googleapis.com/maps/api/geocode/json?latlng=${gpsCoordsString}&amp;key=${#sysconfig('google.api.key')}"/>

    <noopStep name="end"/>

    <!-- Input -->
    <contextDataDef name="asset" dataType="Data Object" defaultDataExpression="${subject}"/>

    <!-- Internal -->
    <contextDataDef name="gpsData" dataType="String" defaultDataExpression="${asset.metadata.gPSCoordinates}"/>
    <contextDataDef name="gpsCoordsString" dataType="String"/>

    <contextDataDef name="googleResponseCode" dataType="Integer"/>
    <contextDataDef name="googleResponseString" dataType="String"/>
    <contextDataDef name="googleResponseJson" dataType="JSON"/>

    <contextDataDef name="locationJson" dataType="JSON" defaultDataExpression="{}"/>
    <contextDataDef name="locationMetaId" dataType="String" defaultDataExpression="${#sysconfig('metadata.location.id')}"/>
    <contextDataDef name="reachUrl" dataType="String" defaultDataExpression="${#sysconfig('reachengine.url')}"/>
    <contextDataDef name="workflowApiKey" dataType="String" defaultDataExpression="${#sysconfig('workflow.api.key')}"/>

    <contextDataDef name="googleMapsMetaValue" dataType="String"/>
    <contextDataDef name="appleMapsMetaValue" dataType="String"/>
</workflow>